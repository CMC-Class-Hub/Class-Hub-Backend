name: CD - Build & Deploy # 워크플로우 이름

# main 브랜치에 push(머지 포함)되면 실행
on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write  # OIDC로 AWS Role Assume 하려면 필요 (AccessKey 없이 인증)
  contents: read   # 레포 코드 읽기 권한

env:
  AWS_REGION: ap-northeast-2         # AWS 리전(서울)
  ECR_REPOSITORY: classhub-ecr   # ECR 레포지토리 이름
  APP_PORT: "8080"                   # EC2 host 포트

jobs:
  build-deploy:
    runs-on: ubuntu-latest  # 러너 환경

    steps:
      # 1) 레포 코드를 러너에 내려받음
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Spring Boot JAR 생성
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for Gradle Wrapper
        run: chmod +x ./gradlew

      - name: Build bootJar
        run: ./gradlew bootJar

      # 3) AWS 접근 (OIDC)
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}  # GitHub가 Assume할 AWS IAM Role
          aws-region: ${{ env.AWS_REGION }}           # 리전 설정

      # 4) ECR 로그인 (docker push/pull 가능)
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2 # outputs.registry 로 registry 주소를 받을 수 있음

      # 5) 도커 이미지 빌드 후 ECR에 푸시
      - name: Build & Push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }} .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }}

      # 6) EC2에서 ECR에 있는 도커 이미지를 가져와 실행
      - name: Deploy to EC2 using SSM
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters '{
              "commands": [
                "docker stop classhub-backend || true",
                "docker rm classhub-backend || true",
                "aws ecr get-login-password --region '"$AWS_REGION"' | docker login --username AWS --password-stdin '"$REGISTRY"'",
                "docker pull '"$REGISTRY"'/'"$ECR_REPOSITORY"':'"$GITHUB_SHA"'",
                "docker run -d --name classhub-backend -p \"$APP_PORT\":8080 -e SPRING_PROFILES_ACTIVE=prod \
          -e DB_URL='${{ secrets.DB_URL }}' \
          -e DB_USERNAME='${{ secrets.DB_USERNAME }}' \
          -e DB_PASSWORD='${{ secrets.DB_PASSWORD }}' \
          -e SOLAPI_API_KEY='${{ secrets.SOLAPI_API_KEY }}' \
          -e SOLAPI_API_SECRET='${{ secrets.SOLAPI_API_SECRET }}' \
          -e SOLAPI_FROM='${{ secrets.SOLAPI_FROM }}' \
          -e KAKAO_PF_ID='${{ secrets.KAKAO_PF_ID }}' \
          -e JWT_SECRET='${{ secrets.JWT_SECRET }}' \
          -e AWS_ACCESS_KEY='${{ secrets.AWS_ACCESS_KEY }}' \
          -e AWS_SECRET_KEY='${{ secrets.AWS_SECRET_KEY }}' \
          '"$REGISTRY"'/'"$ECR_REPOSITORY"':'"$GITHUB_SHA"'"
              ]
            }'
